{% extends "base.html" %}
{% load bootstrap3 %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'questions/style.css' %}" />

{% block javascript %}
  <script>
    $('#answer-creation-form').on('submit', function(e){
      e.preventDefault();
      create_question_answer();
    });

    $('#question_comment_form').on('submit', function(e){
      var that = $(this)
      e.preventDefault();
      create_question_comment();
    });

    $('.answers-list').on('submit', "form", function(e){
      e.preventDefault();
      var that = $(this)
      var answer_comment_text = that.children().last().prev().children().last().val()
      comment_on_answer();

      function comment_on_answer() {
        $.ajax({
          url : that.attr('action'),
          type : "POST",
          data : { pk: that.attr('id'), text: answer_comment_text },
          success: function(json) {
            that.children().last().prev().children().last().val('');
            $("#answer-comments-"+json['answer_pk']).append("<p id='answer-comment-"+json.pk+"'>"+json['text']+"<a href='/comments/answer/delete/"+json['pk']+"' title='delete' id='delete-comment-"+json['pk']+"' class='answer-delete-button btn btn-simple'>"+"<span class='glyphicon glyphicon-remove text-danger'></span>"+" "+"<span class='text-danger icon-label'>Delete</span></a></p>")
          }
        })
      }
    })

    $('.answers-list').on('click', "a", function(e){
      e.preventDefault();
      var that = $(this)
      var id_len = that.attr('id').length
      if (that.attr('id').slice(0,10) == 'delete-com') {
        delete_comment();
      } else {
        if (that.attr('id').slice(0,10) == 'delete-ans'){
          delete_answer();
        }
      }
      function delete_answer() {
        $.ajax({
          url : that.attr('href'),
          type : "DELETE",
          data : { pk: that.attr('id').slice(14, id_len) },
          success: function() {
            that.parent().parent().detach()
          }
        })
      }
      function delete_comment() {
        $.ajax({
          url : that.attr('href'),
          type : "DELETE",
          data : { pk: that.attr('id').slice(14, id_len) },
          success: function(json) {
            $('#answer-comment-'+json.pk).detach()
          }
        })
      }
    });

    $('.question-comment-list').on("click", "a", function(e){
      var that = $(this)
      e.preventDefault();
      delete_question_comment();

      function delete_question_comment() {
        $.ajax({
          url : that.attr('href'),
          type : "DELETE",
          data : { pk: that.attr('id') },
          success: function(json) {
            $('#question-comment-'+json.pk).detach()
          }
        })
      }
    });

    function create_question_comment() {
      $.ajax({
        url : '{% url 'comments:create_question_comment' pk=question.pk %}',
        type : "POST",
        data : {the_data : $('#question-comment').val()},
        success : function(json) {
          $('#question-comment').val('');
          $('.question-comment-list').append("<li id='question-comment-"+json['pk']+"'><p>"+json['text']+"<a href='/comments/question/delete/"+json['pk']+"' title='delete' id='"+json['pk']+"' class='btn btn-simple'>"+"<span class='glyphicon glyphicon-remove text-danger'></span>"+" "+"<span class='text-danger icon-label'>Delete</span>"+"</a></p>")
        }
      })
    };

    function create_question_answer() {
      $.ajax({
        url : '{% url 'answers:create' pk=question.pk %}',
        type : "POST",
        data : {the_data : $('#answer').val()},
        success : function(json) {
          $('#answer').val('');
          $('.answers-list').append("<div class='answer-instance'><p><strong>"+json['text']+"</strong></p>"+"<p>answered by: "+"<a href='/accounts/profile/"+json['user_id']+"'>"+json['user']+"</a>"+"<a href='/answers/delete/"+json['pk']+"' title='delete' id='delete-answer-"+json['pk']+"' class='btn btn-simple'>"+"<span class='glyphicon glyphicon-remove text-danger'></span>"+" "+"<span class='text-danger icon-label'>Delete</span>"+"</a><p>comments</p></p>"+"<div class='answer-comment-section' id='answer-comments-"+json['pk']+"'></div><div class='answer-comment form-group'>"+"<form action='/comments/answer/create/"+json['pk']+"/' method='post' id='"+json['pk']+"'>"+"<p><input id='answer-comment' class='form-control' placeholder='comment' type='text' name='answer_comment'></p>"+"<input type='submit' value='Comment on Answer' class='answer-on-comment btn btn-default'>"+"</form></div></div>")
        }
      })
    };

  </script>
{% endblock %}

{% block content %}
<div class="container main-container">
    <h2>
      title: {{question.title}}
    </h2>
    <h3>
      details: {{question.details}}
    </h3>
    <p>asked by: <a href="{% url 'accounts:detail' pk=question.user.id %}">{{question.user.username}}</a>,  on: {{question.created_at}}</p>
    <p>
      {% if user.is_authenticated and question.user.username == request.user.username and not hide_delete %}
          <a href="{% url 'questions:delete' pk=question.pk %}" title="delete" class="btn btn-simple">
            <span class="glyphicon glyphicon-remove text-danger"></span>
            <span class="text-danger icon-label">Delete</span>
          </a>
      {% endif %}
  <div>
    <h4>comments</h4>
    <ul class="question-comment-list">
      {% for comment in question_comments %}
      <li id="question-comment-{{comment.pk}}">
        <p>
          {{comment.text}}
          {% if user.is_authenticated and comment.user.username == request.user.username %}
              <a href="{% url 'comments:delete_question_comment' pk=comment.pk %}" title="delete" id={{comment.pk}} class="btn btn-simple">
                <span class="glyphicon glyphicon-remove text-danger"></span>
                <span class="text-danger icon-label">Delete</span>
              </a>
        </p>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  </div>
      <div class="form-group form-group-sm">
        <form id="question_comment_form" action={% url 'comments:create_question_comment' pk=question.pk %} method="post">
            {% csrf_token %}
            {% bootstrap_form question_comment_form %}
            <input type="submit" value="Comment on Question" id="question-comment" class="btn btn-default">
        </form>
      </div>
    </p>
    <p>vote total: {{question.votes}}</p>
    <p>
      <a href="{% url 'questions:upvote' pk=question.pk %}">Upvote</a>
      <a href="{% url 'questions:downvote' pk=question.pk %}">Downvote</a>
    </p>
    <div class="container answers-list">
      <h3>
        Answers
      </h3>
      {% for answer in question.answers.all %}
        {% include "answers/_answer.html" with answer=answer %}
      {% endfor %}
    </div>
    <h1>Create an Answer</h1>
    <div class="container">
        <form id="answer-creation-form" method="post">
            {% csrf_token %}
            {% bootstrap_form answer_form %}
            <input type="submit" value="Post Answer" class="btn btn-default">
        </form>
    </div>
    <h3>Tags</h3>
    {% if questionstags %}
      {% for tag in questionstags %}
        <a href="{% url 'tags:detail' pk=tag.pk %}">{{tag}}</a>
      {% endfor %}
    {% endif %}
  {% endblock %}
  <script src="static/js/app.js"></script>
</div>
